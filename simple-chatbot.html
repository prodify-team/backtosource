<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back to Source - AI Assistant (No OTP)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .language-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .lang-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
            font-weight: 600;
        }
        
        .lang-btn.active {
            background: #667eea;
            color: white;
        }
        
        .lang-btn:first-child {
            border-radius: 25px 0 0 25px;
        }
        
        .lang-btn:last-child {
            border-radius: 0 25px 25px 0;
        }
        
        .login-container, .chat-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chat-container {
            height: 70vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            margin: -30px -30px 20px -30px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
            white-space: pre-line;
        }
        
        .message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }
        
        .message.ai {
            align-self: flex-start;
            background: #f1f3f4;
            color: #333;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .send-btn:hover {
            background: #5a6fd8;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .suggestion {
            background: #f1f3f4;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
        }
        
        .suggestion:hover {
            background: #e8eaed;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
        }
        
        .login-btn:hover {
            background: #5a6fd8;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-toggle">
            <button class="lang-btn active" onclick="setLanguage('hindi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            <button class="lang-btn" onclick="setLanguage('english')">English</button>
        </div>
        
        <div id="loginContainer" class="login-container">
            <h1 id="loginTitle">‡§¨‡•à‡§ï ‡§ü‡•Ç ‡§∏‡•ã‡§∞‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à</h1>
            <p id="subtitle">350+ Team Members | Multiple Locations</p>
            
            <div id="phoneLoginForm">
                <input type="tel" id="phoneNumber" class="form-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (+91)" maxlength="13">
                <button class="login-btn" onclick="directLogin()" id="loginBtn">Login ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            
            <!-- OTP form completely removed -->
            
            <div id="profileSetupForm" class="hidden">
                <h2>Profile Setup</h2>
                <input type="text" id="userName" class="form-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç">
                <select id="userRole" class="form-select">
                    <option value="">‡§Ö‡§™‡§®‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                    <option value="owner">Owner</option>
                    <option value="regional-manager">Regional Manager</option>
                    <option value="restaurant-manager">Restaurant Manager</option>
                    <option value="head-chef">Head Chef</option>
                    <option value="chef">Chef</option>
                    <option value="waiter">Waiter</option>
                    <option value="cashier">Cashier</option>
                    <option value="cleaner">Cleaner</option>
                    <option value="delivery-boy">Delivery Boy</option>
                    <option value="supervisor">Supervisor</option>
                    <option value="trainee">Trainee</option>
                </select>
                <select id="restaurantLocation" class="form-select">
                    <option value="">Restaurant Location ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                    <option value="delhi-cp">Delhi - Connaught Place</option>
                    <option value="delhi-gk">Delhi - Greater Kailash</option>
                    <option value="mumbai-bandra">Mumbai - Bandra</option>
                    <option value="mumbai-andheri">Mumbai - Andheri</option>
                    <option value="bangalore-koramangala">Bangalore - Koramangala</option>
                    <option value="bangalore-indiranagar">Bangalore - Indiranagar</option>
                    <option value="pune-fc">Pune - FC Road</option>
                    <option value="hyderabad-hitech">Hyderabad - Hi-Tech City</option>
                    <option value="chennai-tnagar">Chennai - T.Nagar</option>
                    <option value="kolkata-saltlake">Kolkata - Salt Lake</option>
                    <option value="ahmedabad-sg">Ahmedabad - SG Highway</option>
                </select>
                <button class="login-btn" onclick="completeRegistration()">Complete Setup</button>
            </div>
        </div>
        
        <div id="chatContainer" class="chat-container hidden">
            <div class="chat-header">
                <h2 id="chatTitle">‡§¨‡•à‡§ï ‡§ü‡•Ç ‡§∏‡•ã‡§∞‡•ç‡§∏ ‡§∏‡§π‡§æ‡§Ø‡§ï</h2>
            </div>
            
            <div class="suggestions" id="suggestions">
                <div class="suggestion" onclick="sendSuggestion('‡§¶‡§æ‡§≤ ‡§Æ‡§ñ‡§®‡•Ä ‡§ï‡•à‡§∏‡•á ‡§¨‡§®‡§æ‡§è‡§Ç?')">‡§¶‡§æ‡§≤ ‡§Æ‡§ñ‡§®‡•Ä ‡§ï‡•à‡§∏‡•á ‡§¨‡§®‡§æ‡§è‡§Ç?</div>
                <div class="suggestion" onclick="sendSuggestion('‡§Ü‡§ú ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?')">‡§Ü‡§ú ‡§ï‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?</div>
                <div class="suggestion" onclick="sendSuggestion('‡§ñ‡§æ‡§®‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•à‡§∏‡•á ‡§∞‡§ñ‡•á‡§Ç?')">‡§ñ‡§æ‡§®‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•à‡§∏‡•á ‡§∞‡§ñ‡•á‡§Ç?</div>
                <div class="suggestion" onclick="sendSuggestion('customer service tips')">customer service tips</div>
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="input-container">
                <input type="text" id="messageInput" class="message-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç...">
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'hindi';
        let currentUser = null;
        let tempPhoneNumber = null;
        let isNewUser = false;
        
        const texts = {
            hindi: {
                loginTitle: '‡§¨‡•à‡§ï ‡§ü‡•Ç ‡§∏‡•ã‡§∞‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à',
                namePlaceholder: '‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç',
                roles: {
                    chef: '‡§∞‡§∏‡•ã‡§á‡§Ø‡§æ',
                    waiter: '‡§µ‡•á‡§ü‡§∞',
                    manager: '‡§Æ‡•à‡§®‡•á‡§ú‡§∞',
                    owner: '‡§Æ‡§æ‡§≤‡§ø‡§ï',
                    cleaner: '‡§∏‡§´‡§æ‡§à ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä'
                },
                loginButton: '‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç',
                chatTitle: '‡§¨‡•à‡§ï ‡§ü‡•Ç ‡§∏‡•ã‡§∞‡•ç‡§∏ ‡§∏‡§π‡§æ‡§Ø‡§ï',
                placeholder: '‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç...',
                suggestions: ['‡§Æ‡•á‡§∞‡•á ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì', '‡§∞‡§æ‡§ú ‡§ï‡•ã ‡§¶‡§æ‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§¶‡•ã', '‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü', '‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø gas ‡§®‡§π‡•Ä‡§Ç ‡§Ü ‡§∞‡§π‡•Ä']
            },
            english: {
                loginTitle: 'Welcome to Back to Source',
                namePlaceholder: 'Enter your name',
                roles: {
                    chef: 'Chef',
                    waiter: 'Waiter',
                    manager: 'Manager',
                    owner: 'Owner',
                    cleaner: 'Cleaner'
                },
                loginButton: 'Start',
                chatTitle: 'Back to Source Assistant',
                placeholder: 'Type your message here...',
                suggestions: ['Show my tasks', 'Assign make tea to Raj', 'Task completed', 'Delayed because gas not working']
            }
        };
        
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTexts();
        }
        
        function updateTexts() {
            const t = texts[currentLanguage];
            document.getElementById('loginTitle').textContent = t.loginTitle;
            document.getElementById('userName').placeholder = t.namePlaceholder;
            document.querySelector('.login-btn').textContent = t.loginButton;
            document.getElementById('chatTitle').textContent = t.chatTitle;
            document.getElementById('messageInput').placeholder = t.placeholder;
            
            // Update role options
            const roleSelect = document.getElementById('userRole');
            roleSelect.innerHTML = '';
            Object.entries(t.roles).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value;
                roleSelect.appendChild(option);
            });
            
            // Update suggestions
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.innerHTML = '';
            t.suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = suggestion;
                div.onclick = () => sendSuggestion(suggestion);
                suggestionsContainer.appendChild(div);
            });
        }
        
        async function directLogin() {
            const phoneInput = document.getElementById('phoneNumber');
            let phone = phoneInput.value.trim();
            
            // Format phone number
            if (!phone.startsWith('+91')) {
                if (phone.startsWith('91')) {
                    phone = '+' + phone;
                } else if (phone.length === 10) {
                    phone = '+91' + phone;
                } else {
                    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç');
                    return;
                }
            }
            
            tempPhoneNumber = phone;
            console.log('Direct login mode - phone:', phone);
            
            // Always treat as new user for demo (no backend check)
            isNewUser = true;
            
            // Show profile setup directly
            document.getElementById('phoneLoginForm').classList.add('hidden');
            document.getElementById('profileSetupForm').classList.remove('hidden');
        }
        
        // OTP function removed - using direct login now
        
        async function loginExistingUser() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: tempPhoneNumber })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    startChatSession();
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§');
            }
        }
        
        async function completeRegistration() {
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const location = document.getElementById('restaurantLocation').value;
            
            if (!name || !role || !location) {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä fields ‡§≠‡§∞‡•á‡§Ç');
                return;
            }
            
            // Create user object directly for demo
            currentUser = {
                phone: tempPhoneNumber,
                name: name,
                role: role,
                location: location,
                preferredLanguage: 'hinglish'
            };
            
            console.log('User registered:', currentUser);
            startChatSession();
            
            /* Backend registration - temporarily disabled
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: tempPhoneNumber,
                        name,
                        role,
                        location
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    startChatSession();
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§');
            }
            */
        }
        
        function startChatSession() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');
            
            const { name, role, location } = currentUser;
            
            // Welcome message with exact commands
            let welcomeMsg = '';
            if (currentLanguage === 'hindi') {
                if (role === 'owner' || role.includes('manager')) {
                    welcomeMsg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${name}! (${location})\n\nüìã Manager Commands:\n‚Ä¢ "‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì" - ‡§∏‡§≠‡•Ä ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§¶‡•á‡§ñ‡•á‡§Ç\n‚Ä¢ "‡§∞‡§æ‡§ú ‡§ï‡•ã ‡§¶‡§æ‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§¶‡•ã" - ‡§ï‡§æ‡§Æ assign ‡§ï‡§∞‡•á‡§Ç\n‚Ä¢ "team performance ‡§¶‡§ø‡§ñ‡§æ‡§ì" - analytics ‡§¶‡•á‡§ñ‡•á‡§Ç`;
                } else {
                    welcomeMsg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${name}! (${location})\n\nüìã Staff Commands:\n‚Ä¢ "‡§Æ‡•á‡§∞‡•á ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì" - ‡§Ö‡§™‡§®‡•á ‡§ï‡§æ‡§Æ ‡§¶‡•á‡§ñ‡•á‡§Ç\n‚Ä¢ "‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü" - ‡§ï‡§æ‡§Æ complete ‡§ï‡§∞‡•á‡§Ç\n‚Ä¢ "‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø..." - problem report ‡§ï‡§∞‡•á‡§Ç`;
                }
            } else {
                if (role === 'owner' || role.includes('manager')) {
                    welcomeMsg = `Hello ${name}! (${location})\n\nüìã Manager Commands:\n‚Ä¢ "Show my tasks" - View all tasks\n‚Ä¢ "Assign make tea to Raj" - Assign new task\n‚Ä¢ "Show team performance" - View analytics`;
                } else {
                    welcomeMsg = `Hello ${name}! (${location})\n\nüìã Staff Commands:\n‚Ä¢ "Show my tasks" - View your tasks\n‚Ä¢ "Task completed" - Mark task done\n‚Ä¢ "Delayed because..." - Report problems`;
                }
            }
            
            addMessage(welcomeMsg, 'ai');
        }
        
        function addMessage(text, type) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Debug: Check if user is logged in
            if (!currentUser) {
                addMessage('Please login first!', 'ai');
                return;
            }
            
            addMessage(message, 'user');
            input.value = '';
            
            // Check for task-related commands
            const lowerMessage = message.toLowerCase();
            
            // Show tasks
            if (lowerMessage.includes('show my tasks') || lowerMessage.includes('‡§Æ‡•á‡§∞‡•á ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì') || lowerMessage.includes('my tasks') || lowerMessage.includes('‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì')) {
                await showTasks();
                return;
            }
            
            // Task completion
            if (lowerMessage.includes('‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü') || lowerMessage.includes('task completed') || lowerMessage.includes('done') || lowerMessage.includes('complete')) {
                await updateTaskStatus('completed', 'Task completed');
                return;
            }
            
            // Task delay reporting
            if (lowerMessage.includes('‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à') || lowerMessage.includes('delayed because') || lowerMessage.includes('problem')) {
                const reason = message.replace(/‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø|delayed because|problem:/gi, '').trim();
                await updateTaskStatus('delayed', reason || 'Delay reported');
                return;
            }
            
            // Task assignment (for managers)
            if (await handleTaskAssignment(message)) {
                return;
            }
            
            // Show typing indicator
            addMessage(currentLanguage === 'hindi' ? '‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...' : 'Typing...', 'ai');
            
            try {
                console.log('Sending message:', message, 'User:', currentUser);
                
                const response = await fetch('/api/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        userRole: currentUser.role,
                        preferredLanguage: currentLanguage
                    })
                });
                
                console.log('Response status:', response.status);
                
                // Remove typing indicator
                const messages = document.getElementById('messages');
                messages.removeChild(messages.lastChild);
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.response, 'ai');
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                // Remove typing indicator
                const messages = document.getElementById('messages');
                if (messages.lastChild) {
                    messages.removeChild(messages.lastChild);
                }
                
                const errorMsg = currentLanguage === 'hindi' ? 
                    '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç, server ‡§∏‡•á connection ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ ‡§∞‡§π‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ backend ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à?' :
                    'Sorry, cannot connect to server. Is the backend running?';
                addMessage(errorMsg, 'ai');
            }
        }
        
        async function showTasks() {
            try {
                // For managers/owners, show all tasks. For others, show their assigned tasks
                const endpoint = (currentUser.role === 'manager' || currentUser.role === 'owner') ? 
                    '/api/tasks/all/tasks' :
                    `/api/tasks/assignee/${encodeURIComponent(currentUser.name)}`;
                
                console.log('Fetching tasks from:', endpoint);
                console.log('Current user:', currentUser);
                
                const response = await fetch(endpoint);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    const tasks = data.tasks;
                    const summary = data.summary;
                    
                    let taskMessage = '';
                    
                    if (currentUser.role === 'manager' || currentUser.role === 'owner') {
                        taskMessage = currentLanguage === 'hindi' ? 
                            `üìã ‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§Æ (‡§ï‡•Å‡§≤: ${summary.total})\n\n` :
                            `üìã All Tasks (Total: ${summary.total})\n\n`;
                    } else {
                        taskMessage = currentLanguage === 'hindi' ? 
                            `üìã ‡§Ü‡§™‡§ï‡•á ‡§ï‡§æ‡§Æ (‡§ï‡•Å‡§≤: ${summary.total})\n\n` :
                            `üìã Your Tasks (Total: ${summary.total})\n\n`;
                    }
                    
                    if (tasks.length === 0) {
                        taskMessage += currentLanguage === 'hindi' ? 
                            '‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! üéâ' :
                            'No tasks found. Great job! üéâ';
                    } else {
                        tasks.forEach(task => {
                            const statusEmoji = task.status === 'completed' ? '‚úÖ' : 
                                              task.status === 'in-progress' ? 'üîÑ' : 
                                              task.status === 'delayed' ? '‚ö†Ô∏è' : '‚è≥';
                            
                            taskMessage += `${statusEmoji} ${task.title}\n`;
                            taskMessage += `   üë§ ${task.assignedTo} (by ${task.assignedBy})\n`;
                            taskMessage += `   üìù ${task.description}\n`;
                            
                            if (task.statusNote) {
                                taskMessage += `   üí¨ "${task.statusNote}"\n`;
                            }
                            
                            if (task.status !== 'completed') {
                                taskMessage += `   üìä Status: ${task.status}\n`;
                            }
                            
                            const createdTime = new Date(task.createdAt).toLocaleTimeString('hi-IN', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            taskMessage += `   üïê ${createdTime}\n\n`;
                        });
                        
                        // Show quick action suggestions for non-managers
                        if (currentUser.role !== 'manager' && currentUser.role !== 'owner') {
                            const pendingTasks = tasks.filter(t => t.status === 'pending' || t.status === 'in-progress');
                            if (pendingTasks.length > 0) {
                                taskMessage += currentLanguage === 'hindi' ? 
                                    '\nüí° ‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç: "‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü"\nüí° ‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ‡§§‡•ã ‡§≤‡§ø‡§ñ‡•á‡§Ç: "‡§¶‡•á‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø..."' :
                                    '\nüí° When done, type: "Task completed"\nüí° If delayed, type: "Delayed because..."';
                            }
                        }
                    }
                    
                    addMessage(taskMessage, 'ai');
                } else {
                    throw new Error('Failed to fetch tasks');
                }
            } catch (error) {
                const errorMsg = currentLanguage === 'hindi' ? 
                    '‡§ï‡§æ‡§Æ ‡§ï‡•Ä list ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§™‡§æ‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§' :
                    'Could not fetch tasks. Please try again later.';
                addMessage(errorMsg, 'ai');
            }
        }
        
        async function updateTaskStatus(status, note) {
            try {
                // Get user's pending tasks first
                const response = await fetch(`/api/tasks/assignee/${currentUser.name}`);
                const data = await response.json();
                
                if (data.success && data.tasks.length > 0) {
                    // Find the most recent pending/in-progress task
                    const activeTask = data.tasks.find(task => 
                        task.status === 'pending' || task.status === 'in-progress'
                    );
                    
                    if (activeTask) {
                        // Update the task status
                        const updateResponse = await fetch(`/api/tasks/${activeTask.id}/status`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                status: status,
                                statusNote: note,
                                updatedBy: currentUser.name
                            })
                        });
                        
                        if (updateResponse.ok) {
                            const successMsg = currentLanguage === 'hindi' ? 
                                `‚úÖ "${activeTask.title}" ‡§ï‡§æ status update ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§\nüí¨ Note: "${note}"` :
                                `‚úÖ "${activeTask.title}" status updated.\nüí¨ Note: "${note}"`;
                            addMessage(successMsg, 'ai');
                        } else {
                            throw new Error('Failed to update task');
                        }
                    } else {
                        const noTaskMsg = currentLanguage === 'hindi' ? 
                            '‡§ï‡•ã‡§à active ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§™‡§π‡§≤‡•á "‡§Æ‡•á‡§∞‡•á ‡§ï‡§æ‡§Æ ‡§¶‡§ø‡§ñ‡§æ‡§ì" ‡§ï‡§∞‡•á‡§Ç‡•§' :
                            'No active tasks found. First check "show my tasks".';
                        addMessage(noTaskMsg, 'ai');
                    }
                } else {
                    const noTaskMsg = currentLanguage === 'hindi' ? 
                        '‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§' :
                        'You have no tasks assigned.';
                    addMessage(noTaskMsg, 'ai');
                }
            } catch (error) {
                const errorMsg = currentLanguage === 'hindi' ? 
                    'Status update ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§' :
                    'Could not update status. Please try again later.';
                addMessage(errorMsg, 'ai');
            }
        }
        
        async function handleTaskAssignment(message) {
            const lowerMessage = message.toLowerCase();
            
            // Simple patterns for task assignment
            if (lowerMessage.includes('‡§ï‡•ã') && (lowerMessage.includes('‡§ï‡§æ‡§Æ ‡§¶‡•ã') || lowerMessage.includes('assign ‡§ï‡§∞‡•ã'))) {
                // Hindi: "‡§∞‡§æ‡§ú ‡§ï‡•ã ‡§¶‡§æ‡§≤ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§¶‡•ã"
                const parts = message.split('‡§ï‡•ã');
                if (parts.length >= 2) {
                    const assignTo = parts[0].trim();
                    const taskPart = parts[1].replace(/‡§ï‡§æ ‡§ï‡§æ‡§Æ ‡§¶‡•ã|assign ‡§ï‡§∞‡•ã/gi, '').trim();
                    await createTaskViaChat(taskPart, assignTo);
                    return true;
                }
            }
            
            if (lowerMessage.includes('assign') && lowerMessage.includes('to')) {
                // English: "assign make dal to raj"
                const assignMatch = message.match(/assign\s+(.+?)\s+to\s+(\w+)/i);
                if (assignMatch) {
                    const taskTitle = assignMatch[1].trim();
                    const assignTo = assignMatch[2].trim();
                    await createTaskViaChat(taskTitle, assignTo);
                    return true;
                }
            }
            
            return false;
        }
        
        async function createTaskViaChat(title, assignTo) {
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        description: `Task assigned via chat by ${currentUser.name}`,
                        assignedTo: assignTo,
                        assignedBy: currentUser.name,
                        role: 'general',
                        priority: 'medium'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const successMsg = currentLanguage === 'hindi' ? 
                        `‚úÖ ‡§ï‡§æ‡§Æ "${title}" ‡§ï‡•ã ${assignTo} ‡§ï‡•ã assign ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§` :
                        `‚úÖ Task "${title}" has been assigned to ${assignTo}.`;
                    addMessage(successMsg, 'ai');
                } else {
                    throw new Error('Failed to create task');
                }
            } catch (error) {
                const errorMsg = currentLanguage === 'hindi' ? 
                    '‡§ï‡§æ‡§Æ assign ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§' :
                    'Could not assign task. Please try again later.';
                addMessage(errorMsg, 'ai');
            }
        }
        
        function sendSuggestion(suggestion) {
            document.getElementById('messageInput').value = suggestion;
            sendMessage();
        }
        
        // Enter key support
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        document.getElementById('userName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>